---
title: "Synthèse ECOVAL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Projet -- `r input$projectname`

<span style='color:#C0504D'>**Site Impacté --> **</span>`r listsite$name[as.numeric(input$selectsiteimpact4)+1]`

<span style='color:#9BBB59'>**Site compensatoire --> **</span>`r listsite$name[as.numeric(input$selectsitecompens4)+1]`

```{r filename, include=FALSE}
inFile <- input$userfile
fileName <- inFile$name
```

* Date : `r format(input$date, "%d %m %Y")`
* Contexte : `r input$projectcontext`
* Fichier : `r fileName`

_Rapport généré le_ `r format(Sys.time(), "%a %d %b %Y %H:%M:%S")`

--------------------------------------
[Site Impacté](#link1)
[Site Compensatoire](#link2)
[Equivalence](#link3)
[Conclusion](#link4)
--------------------------------------

# <span style='color:#C0504D'>**Site Impacté --> `r listsite$name[as.numeric(input$selectsiteimpact4)+1]`**</span> {#link1}

#### **Coordonnées géographiques**

- latitude : `r ecoval[[paste("Site no.", input$selectsiteimpact4)]][4,2]`
- longitude : `r ecoval[[paste("Site no.", input$selectsiteimpact4)]][5,2]`

#### **Surface**

`r ecoval[[paste("Site no.", input$selectsiteimpact4)]][3,2]` ha

#### **Contexte**

`r ecoval[[paste("Site no.", input$selectsiteimpact4)]][6,2]`

## <span style='color:#C0504D'>Etat Initial</span>

### <span style='color:#C0504D'>*Niveau Général*</span>

```{r echo=FALSE, warning=FALSE}
      name <- paste("SIB no.", input$selectsiteimpact4)
      shortindicnames <- c("Nb hab forestier",
                           "Surf hab forestier",
                           "Nb hab ouvert",
                           "Surf hab ouvert",
                           "Nb hab buiss",
                           "Surf hab buiss",
                           "Nb hab rocheux",
                           "Surf hab rocheux",
                           "Nb hab humide",
                           "Surf hab humide",
                           "Nb hab aqua",
                           "Surf hab aqua",
                           "Lg lisière _ ha forêt",
                           "Diversité avifaune",
                           "Diversité chiroptères",
                           "Diversité reptiles",
                           "Diversité amphibiens",
                           "Diversité mammifères",
                           "Diversité insectes",
                           "Diversité lépidoptères",
                           "Diversité odonates",
                           "Diversité orthoptères",
                           "Diversité coléoptères",
                           "Diversité flore totale",
                           "% habitat en danger localement",
                           "% habitat d'intérêt comm +prio",
                           "% sp protégées faune national et regional",
                           "% sp protégées flore national et regional",
                           "% sp menacées faune national",
                           "% sp menacées flore national",
                           "% sp menacées faune regional",
                           "% sp menacées flore regional",
                           "% sp faune DFFH",
                           "% sp flore DFFH",
                           "% avifaune DO",
                           "% oiseaux nicheurs",
                           "% sp repro site",
                           "Indice de spé avifaune",
                           "% chiroptères spécialistes",
                           "% hab bon état conservation",
                           "Surf milieux NON cultivés",
                           "Surf zones NON urbanisées",
                           "Nb sp EEE",
                           "Nb patchs EEE",
                           "% recouvrement EEE",
                           "Lg linéaire transpt",
                           "Lg linéaire haie",
                           "Surf corridor",
                           "Nb Sp TVB",
                           "% hab forestier _ PE",
                           "% hab ouvert _ PE",
                           "% hab rocheux _ PE",
                           "% hab aqua _ PE",
                           "% hab humide _ PE",
                           "% hab buiss _ PE",
                           "Nb zonage",
                           "Nb Sp faune ZNIEFF",
                           "Nb Sp flore ZNIEFF",
                           "% milieu cultivés_PE",
                           "% zones arti_PE",
                           "Surf EEE prox")
        couleurs <- c("Diversité habitat" = "#83D072",
                      "Diversité espèce" ="#1E6218",
                      "Patrimonialité_PS" = "#9D403E",
                      "Fonctionnalité" = "#4894DC",
                      "Pression_PS" = "#E6A936",
                      "Connectivité" = "#AF76C4",
                      "Représentativité" = "#68DDEA",
                      "Patrimonialité_PE" = "#842D2A",
                      "Pression_PE" = "#DE9830",
                      "Structure" = "grey")
        dat1 <- data.frame(
                          perimetres = ecoval[[name]][[1]][1:24],
                          indicateurs = shortindicnames[1:24],
                          criteres = factor(ecoval[[name]][[2]][1:24], levels=c("Diversité habitat", "Diversité espèce")),
                          valeurs = as.numeric(ecoval[[name]][[4]][1:24]))
        dat2 <- data.frame(
                          perimetres = ecoval[[name]][[1]][25:45],
                          indicateurs = shortindicnames[25:45],
                          criteres = factor(ecoval[[name]][[2]][25:45], levels=c("Patrimonialité_PS","Fonctionnalité", "Pression_PS")),
                          valeurs = as.numeric(ecoval[[name]][[4]][25:45]))
        dat3 <- data.frame(
                          perimetres = ecoval[[name]][[1]][46:61],
                          indicateurs = shortindicnames[46:61],
                          criteres = factor(ecoval[[name]][[2]][46:61], levels=c("Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
                          valeurs = as.numeric(ecoval[[name]][[4]][46:61]))
        dat1$valeurs[is.na(dat1$valeurs)] <- 0
        dat1$valeurs[is.nan(dat1$valeurs)] <- 0
        dat2$valeurs[is.na(dat2$valeurs)] <- 0
        dat2$valeurs[is.nan(dat2$valeurs)] <- 0
        dat3$valeurs[is.na(dat3$valeurs)] <- 0
        dat3$valeurs[is.nan(dat3$valeurs)] <- 0
        ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
        ggplot(data=dat2, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
        ggplot(data=dat3, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#C0504D'>*Identification des enjeux*</span>

**HABITATS**

```{r echo=FALSE, results='asis'}
    # liste les habitats du site impacte
    name <- paste("Site no.", input$selectsiteimpact4)
    habitat <- list()
    nbhabitat <- dim(listhabitat)[1] - 1
    if(nbhabitat > 0){
      for(i in 1:nbhabitat){
        hname <- listhabitat$habitat[i+1]
        if(exists(hname, where = ecoval)){
          if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
            habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
          }
        }
      }
    }
    # affichage
    if(length(habitat) > 0){
      name <- paste("Habitat", habitat[1])
      dat1 <- data.frame(ecoval[[name]][c(2:5,9), 1])
      colnames(dat1)[1] <- ""
      for(i in 1:length(habitat)){
        name <- paste("Habitat", habitat[i])
        if(exists(name, where = ecoval)){
            dat1[[name]] <- ecoval[[name]][c(2:5,9), 2]
            dat1[[name]][3] <- as.character(A1listtype[dat1[[name]][3]])
            colnames(dat1)[i+1] <- ecoval[[name]][1, 2]
        }
      }
      print(knitr::kable(dat1) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left"))
    }
```

**ESPECES**

```{r echo=FALSE, results='asis'}
    # liste les especes du site impacte
    name <- paste("Site no.", input$selectsiteimpact4)
    species <- list()
    nbspecies <- dim(listspecies)[1] - 1
    if(nbspecies > 0){
      for(i in 1:nbspecies){
        sname <- listspecies$species[i+1]
        if(exists(sname, where = ecoval)){
          if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
            species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
          }
        }
      }
    }
    # regroupe les informationq pour affichage
    if(length(species) > 0){
      name <- paste("Espece", species[1])
      dat1 <- data.frame(ecoval[[name]][c(1,3:4,8), 1])
      colnames(dat1)[1] <- ""
      for(i in 1:length(species)){
        name <- paste("Espece", species[i])
        if(exists(name, where = ecoval)){
            dat1[[name]] <- ecoval[[name]][c(1,3:4,8), 2]
            dat1[[name]][2] <- as.character(A2listtype1[dat1[[name]][2]])
            colnames(dat1)[i+1] <- ecoval[[name]][2, 2]
        }
      }
      print(knitr::kable(dat1) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left"))
    }
```

### <span style='color:#C0504D'>*Niveau Habitat*</span>

```{r echo=FALSE, warning=FALSE, fig.align='left', results='asis'}
    # liste les habitats du site impacte
    name <- paste("Site no.", input$selectsiteimpact4)
    habitat <- list()
    nbhabitat <- dim(listhabitat)[1] - 1
    if(nbhabitat > 0){
      for(i in 1:nbhabitat){
        hname <- listhabitat$habitat[i+1]
        if(exists(hname, where = ecoval)){
          if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
            habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
          }
        }
      }
    }
     # affichage
     if(length(habitat) > 0){
       shortindicnames <- c("Nb sp faune dep hab",
                             "Nb sp flore",
                             "Surface totale habitat",
                             "Nombre de patches d'habitat",
                             "Nombre de micro-habitats",
                             "Nb horizons sol",
                             "Epaisseur d'horizons sol",
                             "Abondance relative de faune détritivore",
                             "Nb sp faune dep hab reproduction",
                             "Nb TGB",
                             "% bois mort",
                             "Nb sp bio-indicatrices",
                             "Densité de lichen",
                             "Ancienneté de la forêt",
                             "Nb sp pollinisatrices",
                             "% flore dominante",
                             "Nb strates végétation",
                             "Hauteur strates",
                             "% sol dégradé",
                             "Nb sp indicatrices de pression",
                             "Tps depuis dernière coupe",
                             "Tx recouvrement ligneux",
                             "Tx couvert algues eutrophisation",
                             "Indice frag type hab",
                             "Surface d'habitat dans le PE",
                             "% surf hab _ PE")
      couleurs <- c("Diversité habitat" = "#83D072",
                        "Diversité espèce" ="#1E6218",
                        "Patrimonialité_PS" = "#9D403E",
                        "Fonctionnalité" = "#4894DC",
                        "Pression_PS" = "#E6A936",
                        "Connectivité" = "#AF76C4",
                        "Représentativité" = "#68DDEA",
                        "Patrimonialité_PE" = "#842D2A",
                        "Pression_PE" = "#DE9830",
                        "Structure" = "grey")
       for(i in 1:length(habitat)){
         name <- paste("CI no.", habitat[i])
         if(exists(name, where = ecoval)){
          namehab <- paste("Habitat", habitat[i])
          partial_select <- c(1,2,3,4,5,6,7,8,9,16,17,18,19,20,24,25,26)
          if(ecoval[[namehab]][4,2] == "1"){ # Fermé
            partial_select <- c(partial_select, c(10,11,12,13,14,21))
          }else if(ecoval[[namehab]][4,2] == "2"){ # Ouvert
            partial_select <- c(partial_select, c(15, 22))
          }else if(ecoval[[namehab]][4,2] == "4"){ # Zone humide
            partial_select <- c(partial_select, c(16, 23))
          }
          tabhab <- ecoval[[name]][partial_select,]
          tabhab[[3]] <- shortindicnames[partial_select]
          cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), "**", "\n\n", sep=''))
          dat1 <- data.frame(
            perimetres = tabhab[[1]],
            indicateurs = tabhab[[3]],
            criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce",
                                                    "Patrimonialité_PS","Fonctionnalité","Pression_PS",
                                                    "Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            valeurs = as.numeric(tabhab[[4]])
          )
          dat1$valeurs[is.na(dat1$valeurs)] <- 0
          dat1$valeurs[is.nan(dat1$valeurs)] <- 0
          p <- ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
            geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
            theme_bw()+
            scale_fill_manual(values=couleurs)+
            geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
            theme(legend.position='none')+
            labs(x="Indicateurs", y="Valeur à l'état initial")+
            facet_grid(.~criteres, scales = "free", space ="free")+
            theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
          print(p)
         }
       }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#C0504D'>*Niveau Espèce*</span>

```{r echo=FALSE, warning=FALSE, fig.align='left', results='asis'}
# liste les especes du site impacte
      name <- paste("Site no.", input$selectsiteimpact4)
      species <- list()
      nbspecies <- dim(listspecies)[1] - 1
      if(nbspecies > 0){
        for(i in 1:nbspecies){
          sname <- listspecies$species[i+1]
          if(exists(sname, where = ecoval)){
            if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
              species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
            }
          }
        }
      }
     # affichage
     if(length(species) > 0){
        shortindicnames <- c("Surf tot hab favorable",
                             "Nb patchs hab favorable",
                             "Estimation nb indiv",
                             "Surf nourrissage favorable",
                             "Surf reproduction favorable",
                             "Estimation nb couples",
                             "Surf chasse favorable",
                             "Nb gîtes favorables",
                             "Nb mâles chanteurs",
                             "Nb pontes",
                             "% plante(s) hôte(s)",
                             "Nb station / pieds",
                             "Nombre d'sp",
                             "Nombre de familles",
                             "% Surf SANS perturbation",
                             "Surf hab favorable _ PE",
                             "Nb osb sp",
                             "Surf hab favorable connecté _ PE",
                             "Nb zones connectées entre elles")
        couleurs <- c("Diversité habitat" = "#83D072",
                        "Diversité espèce" ="#1E6218",
                        "Patrimonialité_PS" = "#9D403E",
                        "Fonctionnalité" = "#4894DC",
                        "Pression_PS" = "#E6A936",
                        "Connectivité" = "#AF76C4",
                        "Représentativité" = "#68DDEA",
                        "Patrimonialité_PE" = "#842D2A",
                        "Pression_PE" = "#DE9830",
                        "Structure" = "grey")
       for(i in 1:length(species)){
         name <- paste("DI no.", species[i])
         if(exists(name, where = ecoval)){
             namesp  <- paste("Espece", species[i])
             partial_select <- c(1,2,15,16,17,18,19)
              if(ecoval[[namesp]][3,2] != "7"){ # Faune
                partial_select <- c(partial_select, c(3))
              }
              if(ecoval[[namesp]][3,2] == "1"){ # Avifaune
                partial_select <- c(partial_select, c(4,5,6))
              }else if(ecoval[[namesp]][3,2] == "2"){ # Chiroptere
                partial_select <- c(partial_select, c(7,8))
              }else if(ecoval[[namesp]][3,2] == "4"){ # Amphibien
                partial_select <- c(partial_select, c(9,10))
              }else if(ecoval[[namesp]][3,2] == "6"){ # Insecte
                partial_select <- c(partial_select, c(11))
              }else if(ecoval[[namesp]][3,2] == "7"){ # Flore
                partial_select <- c(partial_select, c(12))
              }else if(ecoval[[namesp]][3,2] == "10"){ # Communaute faunistique
                partial_select <- c(partial_select, c(13,14))
              }
              tabsp <- ecoval[[name]][partial_select,]
              tabsp[[3]] <- shortindicnames[partial_select]
              cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), "**", "\n\n", sep=''))
              dat1 <- data.frame(
                perimetres = tabsp[[1]],
                indicateurs = tabsp[[3]],
                criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS",
                                                       "Fonctionnalité","Pression_PS","Connectivité","Représentativité",
                                                       "Patrimonialité_PE","Pression_PE", "Structure")),
                valeurs = as.numeric(tabsp[[4]]))
              dat1$valeurs[is.na(dat1$valeurs)] <- 0
              dat1$valeurs[is.nan(dat1$valeurs)] <- 0
              p <- ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
                geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
                theme_bw()+
                scale_fill_manual(values=couleurs)+
                geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+2))+
                theme(legend.position='none')+
                labs(x="Indicateurs", y="Valeur à l'état initial")+
                facet_grid(.~criteres, scales = "free", space ="free")+
                theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
              print(p)
          }
        }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

## <span style='color:#C0504D'>Impacts sur `r listsite$name[as.numeric(input$selectsiteimpact4)+1]`</span>

#### **Description qualitative**
`r ecoval[[paste("Site no.", input$selectsiteimpact4)]][7,2]`

#### **Temporalité**

`r ecoval[[paste("Site no.", input$selectsiteimpact4)]][8,2]`

#### **Durée**

`r if(ecoval[[paste("Site no.", input$selectsiteimpact4)]][9,2] > 0) duree[ecoval[[paste("Site no.", input$selectsiteimpact4)]][9,2]]`

#### **Intensité**

`r if(ecoval[[paste("Site no.", input$selectsiteimpact4)]][10,2] > 0) intensite[ecoval[[paste("Site no.", input$selectsiteimpact4)]][10,2]]`

#### **Portée spatiale**

`r if(ecoval[[paste("Site no.", input$selectsiteimpact4)]][11,2] > 0) portee[ecoval[[paste("Site no.", input$selectsiteimpact4)]][11,2]]`

## <span style='color:#C0504D'>Pertes</span>

### <span style='color:#C0504D'>*Niveau Général*</span>

#### **Court Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
      name <- paste("SIB no.", input$selectsiteimpact4)
      shortindicnames <- c("Nb hab forestier",
                           "Surf hab forestier",
                           "Nb hab ouvert",
                           "Surf hab ouvert",
                           "Nb hab buiss",
                           "Surf hab buiss",
                           "Nb hab rocheux",
                           "Surf hab rocheux",
                           "Nb hab humide",
                           "Surf hab humide",
                           "Nb hab aqua",
                           "Surf hab aqua",
                           "Lg lisière _ ha forêt",
                           "Diversité avifaune",
                           "Diversité chiroptères",
                           "Diversité reptiles",
                           "Diversité amphibiens",
                           "Diversité mammifères",
                           "Diversité insectes",
                           "Diversité lépidoptères",
                           "Diversité odonates",
                           "Diversité orthoptères",
                           "Diversité coléoptères",
                           "Diversité flore totale",
                           "% habitat en danger localement",
                           "% habitat d'intérêt comm +prio",
                           "% sp protégées faune national et regional",
                           "% sp protégées flore national et regional",
                           "% sp menacées faune national",
                           "% sp menacées flore national",
                           "% sp menacées faune regional",
                           "% sp menacées flore regional",
                           "% sp faune DFFH",
                           "% sp flore DFFH",
                           "% avifaune DO",
                           "% oiseaux nicheurs",
                           "% sp repro site",
                           "Indice de spé avifaune",
                           "% chiroptères spécialistes",
                           "% hab bon état conservation",
                           "Surf milieux NON cultivés",
                           "Surf zones NON urbanisées",
                           "Nb sp EEE",
                           "Nb patchs EEE",
                           "% recouvrement EEE",
                           "Lg linéaire transpt",
                           "Lg linéaire haie",
                           "Surf corridor",
                           "Nb Sp TVB",
                           "% hab forestier _ PE",
                           "% hab ouvert _ PE",
                           "% hab rocheux _ PE",
                           "% hab aqua _ PE",
                           "% hab humide _ PE",
                           "% hab buiss _ PE",
                           "Nb zonage",
                           "Nb Sp faune ZNIEFF",
                           "Nb Sp flore ZNIEFF",
                           "% milieu cultivés_PE",
                           "% zones arti_PE",
                           "Surf EEE prox")
      # Pertes CT
      dat1 <- data.frame(
         perimetres = ecoval[[name]][[1]],
         indicateurs = shortindicnames, # ecoval[[name]][[3]],
         criteres = factor(ecoval[[name]][[2]], levels=c("Diversité habitat",
            "Diversité espèce",
            "Patrimonialité_PS",
            "Fonctionnalité",
            "Pression_PS",
            "Connectivité",
            "Représentativité",
            "Patrimonialité_PE",
            "Pression_PE",
            "Structure")),
         # valeurs = as.numeric(ecoval[[name]][[4]]),
         incertitudes <- gsub("[ABC]", "*", ecoval[[name]][[6]]),
         pertes_brutes <- as.numeric(ecoval[[name]][[7]]) - as.numeric(ecoval[[name]][[4]]),
         pertes_relatives <- (as.numeric(ecoval[[name]][[7]]) - as.numeric(ecoval[[name]][[4]])) * 100 / as.numeric(ecoval[[name]][[4]])
      )
      dat1[[5]][is.na(dat1[[5]])] <- 0
      dat1[[5]][is.nan(dat1[[5]])] <- 0
      dat1[[6]][is.na(dat1[[6]])] <- 0
      dat1[[6]][is.nan(dat1[[6]])] <- 0
      dat1[[6]][is.infinite(dat1[[6]])] <- 0
      dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
      p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
         geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
         coord_flip()+
         labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
         scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
         theme_bw()+
         theme(legend.position="none")+
         geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
         theme(axis.text.x=element_text(colour="black", size = 11))+
         geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
         theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
         facet_grid(criteres ~ ., scales = "free", space = "free")
    print(p)
```

#### **Long Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
      name <- paste("SIB no.", input$selectsiteimpact4)
      shortindicnames <- c("Nb hab forestier",
                           "Surf hab forestier",
                           "Nb hab ouvert",
                           "Surf hab ouvert",
                           "Nb hab buiss",
                           "Surf hab buiss",
                           "Nb hab rocheux",
                           "Surf hab rocheux",
                           "Nb hab humide",
                           "Surf hab humide",
                           "Nb hab aqua",
                           "Surf hab aqua",
                           "Lg lisière _ ha forêt",
                           "Diversité avifaune",
                           "Diversité chiroptères",
                           "Diversité reptiles",
                           "Diversité amphibiens",
                           "Diversité mammifères",
                           "Diversité insectes",
                           "Diversité lépidoptères",
                           "Diversité odonates",
                           "Diversité orthoptères",
                           "Diversité coléoptères",
                           "Diversité flore totale",
                           "% habitat en danger localement",
                           "% habitat d'intérêt comm +prio",
                           "% sp protégées faune national et regional",
                           "% sp protégées flore national et regional",
                           "% sp menacées faune national",
                           "% sp menacées flore national",
                           "% sp menacées faune regional",
                           "% sp menacées flore regional",
                           "% sp faune DFFH",
                           "% sp flore DFFH",
                           "% avifaune DO",
                           "% oiseaux nicheurs",
                           "% sp repro site",
                           "Indice de spé avifaune",
                           "% chiroptères spécialistes",
                           "% hab bon état conservation",
                           "Surf milieux NON cultivés",
                           "Surf zones NON urbanisées",
                           "Nb sp EEE",
                           "Nb patchs EEE",
                           "% recouvrement EEE",
                           "Lg linéaire transpt",
                           "Lg linéaire haie",
                           "Surf corridor",
                           "Nb Sp TVB",
                           "% hab forestier _ PE",
                           "% hab ouvert _ PE",
                           "% hab rocheux _ PE",
                           "% hab aqua _ PE",
                           "% hab humide _ PE",
                           "% hab buiss _ PE",
                           "Nb zonage",
                           "Nb Sp faune ZNIEFF",
                           "Nb Sp flore ZNIEFF",
                           "% milieu cultivés_PE",
                           "% zones arti_PE",
                           "Surf EEE prox")
                           # Pertes LT
      dat1 <- data.frame(
         perimetres = ecoval[[name]][[1]],
         indicateurs = shortindicnames, # ecoval[[name]][[3]],
         criteres = factor(ecoval[[name]][[2]], levels=c("Diversité habitat",
                                                        "Diversité espèce",
                                                        "Patrimonialité_PS",
                                                        "Fonctionnalité",
                                                        "Pression_PS",
                                                        "Connectivité",
                                                        "Représentativité",
                                                        "Patrimonialité_PE",
                                                        "Pression_PE",
                                                        "Structure")),
         #valeurs = as.numeric(ecoval[[name]][[4]],
         incertitudes <- gsub("[ABC]", "*", ecoval[[name]][[9]]),
         pertes_brutes <- as.numeric(ecoval[[name]][[10]]) - as.numeric(ecoval[[name]][[4]]),
         pertes_relatives <- (as.numeric(ecoval[[name]][[10]]) - as.numeric(ecoval[[name]][[4]])) * 100 / as.numeric(ecoval[[name]][[4]])
      )
      dat1[[5]][is.na(dat1[[5]])] <- 0
      dat1[[5]][is.nan(dat1[[5]])] <- 0
      dat1[[6]][is.na(dat1[[6]])] <- 0
      dat1[[6]][is.nan(dat1[[6]])] <- 0
      dat1[[6]][is.infinite(dat1[[6]])] <- 0
      dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
      p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
         geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
         coord_flip()+
         labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
         scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
         theme_bw()+
         theme(legend.position="none")+
         geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
         theme(axis.text.x=element_text(colour="black", size = 11))+
         geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
         theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
         facet_grid(criteres ~ ., scales = "free", space = "free")
     print(p)
```
<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#C0504D'>*Niveau Habitat*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
# liste les habitats du site impacte
name <- paste("Site no.", input$selectsiteimpact4)
habitat <- list()
nbhabitat <- dim(listhabitat)[1] - 1
if(nbhabitat > 0){
  for(i in 1:nbhabitat){
    hname <- listhabitat$habitat[i+1]
    if(exists(hname, where = ecoval)){
      if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
        habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
      }
    }
  }
}
 # affichage
 if(length(habitat) > 0){
    shortindicnames <- c("Nb sp faune dep hab",
                      "Nb sp flore",
                      "Surface totale habitat",
                      "Nombre de patches d'habitat",
                      "Nombre de micro-habitats",
                      "Nb horizons sol",
                      "Epaisseur d'horizons sol",
                      "Abondance relative de faune détritivore",
                      "Nb sp faune dep hab reproduction",
                      "Nb TGB",
                      "% bois mort",
                      "Nb sp bio-indicatrices",
                      "Densité de lichen",
                      "Ancienneté de la forêt",
                      "Nb sp pollinisatrices",
                      "% flore dominante",
                      "Nb strates végétation",
                      "Hauteur strates",
                      "% sol dégradé",
                      "Nb sp indicatrices de pression",
                      "Tps depuis dernière coupe",
                      "Tx recouvrement ligneux",
                      "Tx couvert algues eutrophisation",
                      "Indice frag type hab",
                      "Surface d'habitat dans le PE",
                      "% surf hab _ PE")

    for(i in 1:length(habitat)){
      name <- paste("CI no.", habitat[i])
      if(exists(name, where = ecoval)){
        namehab <- paste("Habitat", habitat[i])
        partial_select <- c(1,2,3,4,5,6,7,8,9,16,17,18,19,20,24,25,26)
        if(ecoval[[namehab]][4,2] == "1"){ # Fermé
          partial_select <- c(partial_select, c(10,11,12,13,14,21))
        }else if(ecoval[[namehab]][4,2] == "2"){ # Ouvert
          partial_select <- c(partial_select, c(15, 22))
        }else if(ecoval[[namehab]][4,2] == "4"){ # Zone humide
          partial_select <- c(partial_select, c(16, 23))
        }
        tabhab <- ecoval[[name]][partial_select,]
        tabhab[[3]] <- shortindicnames[partial_select]
        cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Court Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabhab[[1]],
          indicateurs = tabhab[[3]],
          criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
          #valeurs = as.numeric(tabhab[[4]],
          incertitudes <- gsub("[ABC]", "*", tabhab[[7]]),
          pertes_brutes <- as.numeric(tabhab[[8]]) - as.numeric(tabhab[[4]]),
          pertes_relatives <- (as.numeric(tabhab[[8]]) - as.numeric(tabhab[[4]])) * 100 / as.numeric(tabhab[[4]])
        )
        dat1[[5]][is.na(dat1[[5]])] <- 0
        dat1[[5]][is.nan(dat1[[5]])] <- 0
        dat1[[6]][is.na(dat1[[6]])] <- 0
        dat1[[6]][is.nan(dat1[[6]])] <- 0
        dat1[[6]][is.infinite(dat1[[6]])] <- 0
        dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
          geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
       print(p)
       cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Long Terme", "**", "\n\n", sep=''))
       dat1 <- data.frame(
         perimetres = tabhab[[1]],
         indicateurs = tabhab[[3]],
         criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
         #valeurs = as.numeric(tabhab[[4]],
         incertitudes <- gsub("[ABC]", "*", tabhab[[10]]),
         pertes_brutes <- as.numeric(tabhab[[11]]) - as.numeric(tabhab[[4]]),
         pertes_relatives <- (as.numeric(tabhab[[11]]) - as.numeric(tabhab[[4]])) * 100 / as.numeric(tabhab[[4]])
       )
       dat1[[5]][is.na(dat1[[5]])] <- 0
       dat1[[5]][is.nan(dat1[[5]])] <- 0
       dat1[[6]][is.na(dat1[[6]])] <- 0
       dat1[[6]][is.nan(dat1[[6]])] <- 0
       dat1[[6]][is.infinite(dat1[[6]])] <- 0
       dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
       p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
         geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
         coord_flip()+
         labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
         scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
         theme_bw()+
         theme(legend.position="none")+
         geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
         theme(axis.text.x=element_text(colour="black", size = 11))+
         geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
         theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
         facet_grid(criteres ~ ., scales = "free", space = "free")
      print(p)

     }
   }
 }

```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>


### <span style='color:#C0504D'>*Niveau Espèce*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
      # liste les especes du site impacte
      name <- paste("Site no.", input$selectsiteimpact4)
      species <- list()
      nbspecies <- dim(listspecies)[1] - 1
      if(nbspecies > 0){
        for(i in 1:nbspecies){
          sname <- listspecies$species[i+1]
          if(exists(sname, where = ecoval)){
            if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
              species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
            }
          }
        }
      }
     # affichage
     if(length(species) > 0){
        shortindicnames <- c("Surf tot hab favorable",
                             "Nb patchs hab favorable",
                             "Estimation nb indiv",
                             "Surf nourrissage favorable",
                             "Surf reproduction favorable",
                             "Estimation nb couples",
                             "Surf chasse favorable",
                             "Nb gîtes favorables",
                             "Nb mâles chanteurs",
                             "Nb pontes",
                             "% plante(s) hôte(s)",
                             "Nb station / pieds",
                             "Nombre d'sp",
                             "Nombre de familles",
                             "% Surf SANS perturbation",
                             "Surf hab favorable _ PE",
                             "Nb osb sp",
                             "Surf hab favorable connecté _ PE",
                             "Nb zones connectées entre elles")
       for(i in 1:length(species)){
         name <- paste("DI no.", species[i])
         if(exists(name, where = ecoval)){
             namesp  <- paste("Espece", species[i])
             partial_select <- c(1,2,15,16,17,18,19)
            if(ecoval[[namesp]][3,2] != "7"){ # Faune
              partial_select <- c(partial_select, c(3))
            }
            if(ecoval[[namesp]][3,2] == "1"){ # Avifaune
              partial_select <- c(partial_select, c(4,5,6))
            }else if(ecoval[[namesp]][3,2] == "2"){ # Chiroptere
              partial_select <- c(partial_select, c(7,8))
            }else if(ecoval[[namesp]][3,2] == "4"){ # Amphibien
              partial_select <- c(partial_select, c(9,10))
            }else if(ecoval[[namesp]][3,2] == "6"){ # Insecte
              partial_select <- c(partial_select, c(11))
            }else if(ecoval[[namesp]][3,2] == "7"){ # Flore
              partial_select <- c(partial_select, c(12))
            }else if(ecoval[[namesp]][3,2] == "10"){ # Communaute faunistique
              partial_select <- c(partial_select, c(13,14))
            }
            tabsp <- ecoval[[name]][partial_select,]
            tabsp[[3]] <- shortindicnames[partial_select]
            cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Court Terme", "**", "\n\n", sep=''))
            dat1 <- data.frame(
              perimetres = tabsp[[1]],
              indicateurs = tabsp[[3]],
              criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
              # valeurs = as.numeric(tabsp[[4]]),
              incertitudes <- gsub("[ABC]", "*", tabsp[[7]]),
              pertes_brutes <- as.numeric(tabsp[[8]]) - as.numeric(tabsp[[4]]),
              pertes_relatives <- (as.numeric(tabsp[[8]]) - as.numeric(tabsp[[4]])) * 100 / as.numeric(tabsp[[4]])
            )
            dat1[[5]][is.na(dat1[[5]])] <- 0
            dat1[[5]][is.nan(dat1[[5]])] <- 0
            dat1[[6]][is.na(dat1[[6]])] <- 0
            dat1[[6]][is.nan(dat1[[6]])] <- 0
            dat1[[6]][is.infinite(dat1[[6]])] <- 0
            dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
            p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
              geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
              coord_flip()+
              labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
              scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
              theme_bw()+
              theme(legend.position="none")+
              geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
              theme(axis.text.x=element_text(colour="black", size = 11))+
              geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
              theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
              facet_grid(criteres ~ ., scales = "free", space = "free")
            print(p)
            cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Long Terme", "**", "\n\n", sep=''))
            dat1 <- data.frame(
              perimetres = tabsp[[1]],
              indicateurs = tabsp[[3]],
              criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
              # valeurs = as.numeric(tabsp[[4]]),
              incertitudes <- gsub("[ABC]", "*", tabsp[[10]]),
              pertes_brutes <- as.numeric(tabsp[[11]]) - as.numeric(tabsp[[4]]),
              pertes_relatives <- (as.numeric(tabsp[[11]]) - as.numeric(tabsp[[4]])) * 100 / as.numeric(tabsp[[4]])
            )
            dat1[[5]][is.na(dat1[[5]])] <- 0
            dat1[[5]][is.nan(dat1[[5]])] <- 0
            dat1[[6]][is.na(dat1[[6]])] <- 0
            dat1[[6]][is.nan(dat1[[6]])] <- 0
            dat1[[6]][is.infinite(dat1[[6]])] <- 0
            dat1$colour <- ifelse(dat1$pertes_relatives < 0, "negative","positive")
            p <- ggplot(data=dat1, aes(x=indicateurs, y=pertes_relatives)) +
              geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
              coord_flip()+
              labs(x="Indicateurs", y="Pertes relatives (barre) et brutes (nombre)")+
              scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
              theme_bw()+
              theme(legend.position="none")+
              geom_text(aes(label=pertes_brutes, hjust="center", vjust="center", y=pertes_relatives*0.5), size=3)+
              theme(axis.text.x=element_text(colour="black", size = 11))+
              geom_text(aes(label=incertitudes, hjust="center", vjust="top", y= pertes_brutes))+
              theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
              facet_grid(criteres ~ ., scales = "free", space = "free")
            print(p)
          }
        }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

--------------------------------------

# <span style='color:#9BBB59'>**Site Compensatoire -- `r listsite$name[as.numeric(input$selectsitecompens4)+1]`**</span> {#link2}

#### **Coordonnées géographiques**

- latitude : `r ecoval[[paste("Site no.", input$selectsitecompens4)]][4,2]`
- longitude : `r ecoval[[paste("Site no.", input$selectsitecompens4)]][5,2]`

#### **Surface**

`r ecoval[[paste("Site no.", input$selectsitecompens4)]][3,2]` ha

#### **Contexte**

`r ecoval[[paste("Site no.", input$selectsitecompens4)]][6,2]`

## <span style='color:#9BBB59'>Etat Initial</span>

### <span style='color:#9BBB59'>*Niveau Général*</span>

```{r echo=FALSE, warning=FALSE}
        name <- paste("SCB no.", input$selectsitecompens4)
        shortindicnames <- c("Nb hab forestier",
                "Surf hab forestier",
                "Nb hab ouvert",
                "Surf hab ouvert",
                "Nb hab buiss",
                "Surf hab buiss",
                "Nb hab rocheux",
                "Surf hab rocheux",
                "Nb hab humide",
                "Surf hab humide",
                "Nb hab aqua",
                "Surf hab aqua",
                "Lg lisière _ ha forêt",
                "Diversité avifaune",
                "Diversité chiroptères",
                "Diversité reptiles",
                "Diversité amphibiens",
                "Diversité mammifères",
                "Diversité insectes",
                "Diversité lépidoptères",
                "Diversité odonates",
                "Diversité orthoptères",
                "Diversité coléoptères",
                "Diversité flore totale",
                "% habitat en danger localement",
                "% habitat d'intérêt comm +prio",
                "% sp protégées faune national et regional",
                "% sp protégées flore national et regional",
                "% sp menacées faune national",
                "% sp menacées flore national",
                "% sp menacées faune regional",
                "% sp menacées flore regional",
                "% sp faune DFFH",
                "% sp flore DFFH",
                "% avifaune DO",
                "% oiseaux nicheurs",
                "% sp repro site",
                "Indice de spé avifaune",
                "% chiroptères spécialistes",
                "% hab bon état conservation",
                "Surf milieux NON cultivés",
                "Surf zones NON urbanisées",
                "Nb sp EEE",
                "Nb patchs EEE",
                "% recouvrement EEE",
                "Lg linéaire transpt",
                "Lg linéaire haie",
                "Surf corridor",
                "Nb Sp TVB",
                "% hab forestier _ PE",
                "% hab ouvert _ PE",
                "% hab rocheux _ PE",
                "% hab aqua _ PE",
                "% hab humide _ PE",
                "% hab buiss _ PE",
                "Nb zonage",
                "Nb Sp faune ZNIEFF",
                "Nb Sp flore ZNIEFF",
                "% milieu cultivés_PE",
                "% zones arti_PE",
                "Surf EEE prox")
        couleurs <- c("Diversité habitat" = "#83D072",
                              "Diversité espèce" ="#1E6218",
                              "Patrimonialité_PS" = "#9D403E",
                              "Fonctionnalité" = "#4894DC",
                              "Pression_PS" = "#E6A936",
                              "Connectivité" = "#AF76C4",
                              "Représentativité" = "#68DDEA",
                              "Patrimonialité_PE" = "#842D2A",
                              "Pression_PE" = "#DE9830",
                              "Structure" = "grey")
        dat1 <- data.frame(
                          perimetres = ecoval[[name]][[1]][1:24],
                          indicateurs = shortindicnames[1:24],
                          criteres = factor(ecoval[[name]][[2]][1:24], levels=c("Diversité habitat", "Diversité espèce")),
                          valeurs = as.numeric(ecoval[[name]][[4]][1:24]))
        dat2 <- data.frame(
                          perimetres = ecoval[[name]][[1]][25:45],
                          indicateurs = shortindicnames[25:45],
                          criteres = factor(ecoval[[name]][[2]][25:45], levels=c("Patrimonialité_PS","Fonctionnalité", "Pression_PS")),
                          valeurs = as.numeric(ecoval[[name]][[4]][25:45]))
        dat3 <- data.frame(
                          perimetres = ecoval[[name]][[1]][46:61],
                          indicateurs = shortindicnames[46:61],
                          criteres = factor(ecoval[[name]][[2]][46:61], levels=c("Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
                          valeurs = as.numeric(ecoval[[name]][[4]][46:61]))
        dat1$valeurs[is.na(dat1$valeurs)] <- 0
        dat1$valeurs[is.nan(dat1$valeurs)] <- 0
        dat2$valeurs[is.na(dat2$valeurs)] <- 0
        dat2$valeurs[is.nan(dat2$valeurs)] <- 0
        dat3$valeurs[is.na(dat3$valeurs)] <- 0
        dat3$valeurs[is.nan(dat3$valeurs)] <- 0
        ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
        ggplot(data=dat2, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
        ggplot(data=dat3, aes(x=indicateurs, y=valeurs)) +
          geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
          theme_bw()+
          scale_fill_manual(values=couleurs)+
          geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
          theme(legend.position='none')+
          labs(x="Indicateurs", y="Valeur à l'état initial")+
          facet_grid(.~criteres, scales = "free", space ="free")+
          theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#9BBB59'>*Identification des enjeux*</span>

**HABITATS**

```{r echo=FALSE, results='asis'}
    # liste les habitats du site compensatoire
    name <- paste("Site no.", input$selectsitecompens4)
    habitat <- list()
    nbhabitat <- dim(listhabitat)[1] - 1
    if(nbhabitat > 0){
      for(i in 1:nbhabitat){
        hname <- listhabitat$habitat[i+1]
        if(exists(hname, where = ecoval)){
          if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
            habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
          }
        }
      }
    }
    # affichage
    if(length(habitat) > 0){
      name <- paste("Habitat", habitat[1])
      dat1 <- data.frame(ecoval[[name]][c(2:6,9), 1])
      colnames(dat1)[1] <- ""
      for(i in 1:length(habitat)){
        name <- paste("Habitat", habitat[i])
        if(exists(name, where = ecoval)){
            dat1[[name]] <- ecoval[[name]][c(2:6,9), 2]
            if(dat1[[name]][5] == 1) dat1[[name]][5] = 'Oui'
            else dat1[[name]][5] = 'Non'
            dat1[[name]][3] <- as.character(A1listtype[dat1[[name]][3]])
            colnames(dat1)[i+1] <- ecoval[[name]][1, 2]
        }
      }
      print(knitr::kable(dat1) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left"))
    }
```

**ESPECES**

```{r echo=FALSE, results='asis'}
    # liste les especes du site compensatoire
    name <- paste("Site no.", input$selectsitecompens4)
    species <- list()
    nbspecies <- dim(listspecies)[1] - 1
    if(nbspecies > 0){
      for(i in 1:nbspecies){
        sname <- listspecies$species[i+1]
        if(exists(sname, where = ecoval)){
          if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
            species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
          }
        }
      }
    }
    # regroupe les informationq pour affichage
    if(length(species) > 0){
      name <- paste("Espece", species[1])
      dat1 <- data.frame(ecoval[[name]][c(1,3:5,8), 1])
      colnames(dat1)[1] <- ""
      for(i in 1:length(species)){
        name <- paste("Espece", species[i])
        if(exists(name, where = ecoval)){
            dat1[[name]] <- ecoval[[name]][c(1,3:5,8), 2]
            if(dat1[[name]][4] == 1) dat1[[name]][4] = 'Oui'
            else dat1[[name]][4] = 'Non'
            dat1[[name]][2] <- as.character(A2listtype1[dat1[[name]][2]])
            colnames(dat1)[i+1] <- ecoval[[name]][2, 2]
        }
      }
      print(knitr::kable(dat1) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left"))
    }
```
### <span style='color:#9BBB59'>*Niveau Habitat*</span>

```{r echo=FALSE, warning=FALSE, fig.align='left', results='asis'}
    # liste les habitats du site compensatoire
    name <- paste("Site no.", input$selectsitecompens4)
    habitat <- list()
    nbhabitat <- dim(listhabitat)[1] - 1
    if(nbhabitat > 0){
      for(i in 1:nbhabitat){
        hname <- listhabitat$habitat[i+1]
        if(exists(hname, where = ecoval)){
          if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
            habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
          }
        }
      }
    }
     # affichage
     if(length(habitat) > 0){
       shortindicnames <- c("Nb sp faune dep hab",
                             "Nb sp flore",
                             "Surface totale habitat",
                             "Nombre de patches d'habitat",
                             "Nombre de micro-habitats",
                             "Nb horizons sol",
                             "Epaisseur d'horizons sol",
                             "Abondance relative de faune détritivore",
                             "Nb sp faune dep hab reproduction",
                             "Nb TGB",
                             "% bois mort",
                             "Nb sp bio-indicatrices",
                             "Densité de lichen",
                             "Ancienneté de la forêt",
                             "Nb sp pollinisatrices",
                             "% flore dominante",
                             "Nb strates végétation",
                             "Hauteur strates",
                             "% sol dégradé",
                             "Nb sp indicatrices de pression",
                             "Tps depuis dernière coupe",
                             "Tx recouvrement ligneux",
                             "Tx couvert algues eutrophisation",
                             "Indice frag type hab",
                             "Surface d'habitat dans le PE",
                             "% surf hab _ PE")
      couleurs <- c("Diversité habitat" = "#83D072",
                        "Diversité espèce" ="#1E6218",
                        "Patrimonialité_PS" = "#9D403E",
                        "Fonctionnalité" = "#4894DC",
                        "Pression_PS" = "#E6A936",
                        "Connectivité" = "#AF76C4",
                        "Représentativité" = "#68DDEA",
                        "Patrimonialité_PE" = "#842D2A",
                        "Pression_PE" = "#DE9830",
                        "Structure" = "grey")
       for(i in 1:length(habitat)){
         name <- paste("CC no.", habitat[i])
         if(exists(name, where = ecoval)){
          namehab <- paste("Habitat", habitat[i])
          partial_select <- c(1,2,3,4,5,6,7,8,9,16,17,18,19,20,24,25,26)
          if(ecoval[[namehab]][4,2] == "1"){ # Fermé
            partial_select <- c(partial_select, c(10,11,12,13,14,21))
          }else if(ecoval[[namehab]][4,2] == "2"){ # Ouvert
            partial_select <- c(partial_select, c(15, 22))
          }else if(ecoval[[namehab]][4,2] == "4"){ # Zone humide
            partial_select <- c(partial_select, c(16, 23))
          }
          tabhab <- ecoval[[name]][partial_select,]
          tabhab[[3]] <- shortindicnames[partial_select]
          cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), "**", "\n\n", sep=''))
          dat1 <- data.frame(
            perimetres = tabhab[[1]],
            indicateurs = tabhab[[3]],
            criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce",
                                                    "Patrimonialité_PS","Fonctionnalité","Pression_PS",
                                                    "Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            valeurs = as.numeric(tabhab[[4]])
          )
          dat1$valeurs[is.na(dat1$valeurs)] <- 0
          dat1$valeurs[is.nan(dat1$valeurs)] <- 0
          p <- ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
            geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
            theme_bw()+
            scale_fill_manual(values=couleurs)+
            geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+0.5))+
            theme(legend.position='none')+
            labs(x="Indicateurs", y="Valeur à l'état initial")+
            facet_grid(.~criteres, scales = "free", space ="free")+
            theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
          print(p)
         }
       }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#9BBB59'>*Niveau Espèce*</span>

```{r echo=FALSE, warning=FALSE, fig.align='left', results='asis'}
      # liste les especes du site compensatoire
      name <- paste("Site no.", input$selectsitecompens4)
      species <- list()
      nbspecies <- dim(listspecies)[1] - 1
      if(nbspecies > 0){
        for(i in 1:nbspecies){
          sname <- listspecies$species[i+1]
          if(exists(sname, where = ecoval)){
            if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
              species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
            }
          }
        }
      }
     # affichage
     if(length(species) > 0){
        shortindicnames <- c("Surf tot hab favorable",
                             "Nb patchs hab favorable",
                             "Estimation nb indiv",
                             "Surf nourrissage favorable",
                             "Surf reproduction favorable",
                             "Estimation nb couples",
                             "Surf chasse favorable",
                             "Nb gîtes favorables",
                             "Nb mâles chanteurs",
                             "Nb pontes",
                             "% plante(s) hôte(s)",
                             "Nb station / pieds",
                             "Nombre d'sp",
                             "Nombre de familles",
                             "% Surf SANS perturbation",
                             "Surf hab favorable _ PE",
                             "Nb osb sp",
                             "Surf hab favorable connecté _ PE",
                             "Nb zones connectées entre elles")
        couleurs <- c("Diversité habitat" = "#83D072",
                        "Diversité espèce" ="#1E6218",
                        "Patrimonialité_PS" = "#9D403E",
                        "Fonctionnalité" = "#4894DC",
                        "Pression_PS" = "#E6A936",
                        "Connectivité" = "#AF76C4",
                        "Représentativité" = "#68DDEA",
                        "Patrimonialité_PE" = "#842D2A",
                        "Pression_PE" = "#DE9830",
                        "Structure" = "grey")
       for(i in 1:length(species)){
         name <- paste("DC no.", species[i])
         if(exists(name, where = ecoval)){
             namesp  <- paste("Espece", species[i])
             partial_select <- c(1,2,15,16,17,18,19)
              if(ecoval[[namesp]][3,2] != "7"){ # Faune
                partial_select <- c(partial_select, c(3))
              }
              if(ecoval[[namesp]][3,2] == "1"){ # Avifaune
                partial_select <- c(partial_select, c(4,5,6))
              }else if(ecoval[[namesp]][3,2] == "2"){ # Chiroptere
                partial_select <- c(partial_select, c(7,8))
              }else if(ecoval[[namesp]][3,2] == "4"){ # Amphibien
                partial_select <- c(partial_select, c(9,10))
              }else if(ecoval[[namesp]][3,2] == "6"){ # Insecte
                partial_select <- c(partial_select, c(11))
              }else if(ecoval[[namesp]][3,2] == "7"){ # Flore
                partial_select <- c(partial_select, c(12))
              }else if(ecoval[[namesp]][3,2] == "10"){ # Communaute faunistique
                partial_select <- c(partial_select, c(13,14))
              }
              tabsp <- ecoval[[name]][partial_select,]
              tabsp[[3]] <- shortindicnames[partial_select]
              cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), "**", "\n\n", sep=''))
              dat1 <- data.frame(
                perimetres = tabsp[[1]],
                indicateurs = tabsp[[3]],
                criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS",
                                                       "Fonctionnalité","Pression_PS","Connectivité","Représentativité",
                                                       "Patrimonialité_PE","Pression_PE", "Structure")),
                valeurs = as.numeric(tabsp[[4]]))
              dat1$valeurs[is.na(dat1$valeurs)] <- 0
              dat1$valeurs[is.nan(dat1$valeurs)] <- 0
              p <- ggplot(data=dat1, aes(x=indicateurs, y=valeurs)) +
                geom_bar(stat="identity", width=0.5, aes(fill=criteres))+
                theme_bw()+
                scale_fill_manual(values=couleurs)+
                geom_text(aes(label=valeurs,  hjust="center",vjust="bottom", y=valeurs+2))+
                theme(legend.position='none')+
                labs(x="Indicateurs", y="Valeur à l'état initial")+
                facet_grid(.~criteres, scales = "free", space ="free")+
                theme (axis.text.x = element_text(colour="black", angle = 45, size = 10, hjust = 1))
              print(p)
          }
        }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

## <span style='color:#9BBB59'> Mesures compensatoires `r listsite$name[as.numeric(input$selectsitecompens4)+1]`</span>

#### **Description qualitative**
`r ecoval[[paste("Site no.", input$selectsitecompens4)]][7,2]`

#### **Temporalité**

`r ecoval[[paste("Site no.", input$selectsitecompens4)]][8,2]`

#### **Durée**

`r if(ecoval[[paste("Site no.", input$selectsitecompens4)]][9,2] > 0) duree[ecoval[[paste("Site no.", input$selectsitecompens4)]][9,2]]`

#### **Intensité**

`r if(ecoval[[paste("Site no.", input$selectsitecompens4)]][10,2] > 0) intensite[ecoval[[paste("Site no.", input$selectsitecompens4)]][10,2]]`

#### **Portée spatiale**

`r if(ecoval[[paste("Site no.", input$selectsitecompens4)]][11,2] > 0) portee[ecoval[[paste("Site no.", input$selectsitecompens4)]][11,2]]`

## <span style='color:#9BBB59'>Gains</span>

### <span style='color:#9BBB59'>*Niveau Général*</span>

#### **Court Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
      name <- paste("SCB no.", input$selectsitecompens4)
      shortindicnames <- c("Nb hab forestier",
                           "Surf hab forestier",
                           "Nb hab ouvert",
                           "Surf hab ouvert",
                           "Nb hab buiss",
                           "Surf hab buiss",
                           "Nb hab rocheux",
                           "Surf hab rocheux",
                           "Nb hab humide",
                           "Surf hab humide",
                           "Nb hab aqua",
                           "Surf hab aqua",
                           "Lg lisière _ ha forêt",
                           "Diversité avifaune",
                           "Diversité chiroptères",
                           "Diversité reptiles",
                           "Diversité amphibiens",
                           "Diversité mammifères",
                           "Diversité insectes",
                           "Diversité lépidoptères",
                           "Diversité odonates",
                           "Diversité orthoptères",
                           "Diversité coléoptères",
                           "Diversité flore totale",
                           "% habitat en danger localement",
                           "% habitat d'intérêt comm +prio",
                           "% sp protégées faune national et regional",
                           "% sp protégées flore national et regional",
                           "% sp menacées faune national",
                           "% sp menacées flore national",
                           "% sp menacées faune regional",
                           "% sp menacées flore regional",
                           "% sp faune DFFH",
                           "% sp flore DFFH",
                           "% avifaune DO",
                           "% oiseaux nicheurs",
                           "% sp repro site",
                           "Indice de spé avifaune",
                           "% chiroptères spécialistes",
                           "% hab bon état conservation",
                           "Surf milieux NON cultivés",
                           "Surf zones NON urbanisées",
                           "Nb sp EEE",
                           "Nb patchs EEE",
                           "% recouvrement EEE",
                           "Lg linéaire transpt",
                           "Lg linéaire haie",
                           "Surf corridor",
                           "Nb Sp TVB",
                           "% hab forestier _ PE",
                           "% hab ouvert _ PE",
                           "% hab rocheux _ PE",
                           "% hab aqua _ PE",
                           "% hab humide _ PE",
                           "% hab buiss _ PE",
                           "Nb zonage",
                           "Nb Sp faune ZNIEFF",
                           "Nb Sp flore ZNIEFF",
                           "% milieu cultivés_PE",
                           "% zones arti_PE",
                           "Surf EEE prox")
      # Gains CT
      dat1 <- data.frame(
          perimetres = ecoval[[name]][[1]],
          indicateurs = shortindicnames, # ecoval[[name]][[3]],
          criteres = factor(ecoval[[name]][[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
          # valeurs = as.numeric(ecoval[[name]][[7]]),
          incertitudes <- gsub("[ABC]", "*", ecoval[[name]][[6]]),
          gains_bruts <- as.numeric(ecoval[[name]][[7]]) - as.numeric(ecoval[[name]][[4]]),
          gains_relatifs <- (as.numeric(ecoval[[name]][[7]]) - as.numeric(ecoval[[name]][[4]])) * 100 / as.numeric(ecoval[[name]][[4]])
        )
      dat1[[5]][is.na(dat1[[5]])] <- 0
      dat1[[5]][is.nan(dat1[[5]])] <- 0
      dat1[[6]][is.na(dat1[[6]])] <- 0
      dat1[[6]][is.nan(dat1[[6]])] <- 0
      dat1[[6]][is.infinite(dat1[[6]])] <- 0
      dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
      p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
          geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
      print(p)
```

#### **Long Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
      name <- paste("SCB no.", input$selectsitecompens4)
      shortindicnames <- c("Nb hab forestier",
                           "Surf hab forestier",
                           "Nb hab ouvert",
                           "Surf hab ouvert",
                           "Nb hab buiss",
                           "Surf hab buiss",
                           "Nb hab rocheux",
                           "Surf hab rocheux",
                           "Nb hab humide",
                           "Surf hab humide",
                           "Nb hab aqua",
                           "Surf hab aqua",
                           "Lg lisière _ ha forêt",
                           "Diversité avifaune",
                           "Diversité chiroptères",
                           "Diversité reptiles",
                           "Diversité amphibiens",
                           "Diversité mammifères",
                           "Diversité insectes",
                           "Diversité lépidoptères",
                           "Diversité odonates",
                           "Diversité orthoptères",
                           "Diversité coléoptères",
                           "Diversité flore totale",
                           "% habitat en danger localement",
                           "% habitat d'intérêt comm +prio",
                           "% sp protégées faune national et regional",
                           "% sp protégées flore national et regional",
                           "% sp menacées faune national",
                           "% sp menacées flore national",
                           "% sp menacées faune regional",
                           "% sp menacées flore regional",
                           "% sp faune DFFH",
                           "% sp flore DFFH",
                           "% avifaune DO",
                           "% oiseaux nicheurs",
                           "% sp repro site",
                           "Indice de spé avifaune",
                           "% chiroptères spécialistes",
                           "% hab bon état conservation",
                           "Surf milieux NON cultivés",
                           "Surf zones NON urbanisées",
                           "Nb sp EEE",
                           "Nb patchs EEE",
                           "% recouvrement EEE",
                           "Lg linéaire transpt",
                           "Lg linéaire haie",
                           "Surf corridor",
                           "Nb Sp TVB",
                           "% hab forestier _ PE",
                           "% hab ouvert _ PE",
                           "% hab rocheux _ PE",
                           "% hab aqua _ PE",
                           "% hab humide _ PE",
                           "% hab buiss _ PE",
                           "Nb zonage",
                           "Nb Sp faune ZNIEFF",
                           "Nb Sp flore ZNIEFF",
                           "% milieu cultivés_PE",
                           "% zones arti_PE",
                           "Surf EEE prox")
     # Gains LT
    dat1 <- data.frame(
            perimetres = ecoval[[name]][[1]],
            indicateurs = shortindicnames, # ecoval[[name]][[3]],
            criteres = factor(ecoval[[name]][[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            # valeurs = as.numeric(ecoval[[name]][[7]]),
            incertitudes <- gsub("[ABC]", "*", ecoval[[name]][[9]]),
            gains_bruts <- as.numeric(ecoval[[name]][[10]]) - as.numeric(ecoval[[name]][[4]]),
            gains_relatifs <- (as.numeric(ecoval[[name]][[10]]) - as.numeric(ecoval[[name]][[4]])) * 100 / as.numeric(ecoval[[name]][[4]])
          )
    dat1[[5]][is.na(dat1[[5]])] <- 0
    dat1[[5]][is.nan(dat1[[5]])] <- 0
    dat1[[6]][is.na(dat1[[6]])] <- 0
    dat1[[6]][is.nan(dat1[[6]])] <- 0
    dat1[[6]][is.infinite(dat1[[6]])] <- 0
    dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
    p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
            geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
            coord_flip()+
            labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
            scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
            theme_bw()+
            theme(legend.position="none")+
            geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
            theme(axis.text.x=element_text(colour="black", size = 11))+
            geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
            theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
            facet_grid(criteres ~ ., scales = "free", space = "free")
     print(p)
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#9BBB59'>*Niveau Habitat*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
# liste les habitats du site compensatoire
name <- paste("Site no.", input$selectsitecompens4)
habitat <- list()
nbhabitat <- dim(listhabitat)[1] - 1
if(nbhabitat > 0){
  for(i in 1:nbhabitat){
    hname <- listhabitat$habitat[i+1]
    if(exists(hname, where = ecoval)){
      if(ecoval[[hname]][7,2] == ecoval[[name]][12,2]){
        habitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
      }
    }
  }
}
 # affichage
 if(length(habitat) > 0){
    shortindicnames <- c("Nb sp faune dep hab",
                      "Nb sp flore",
                      "Surface totale habitat",
                      "Nombre de patches d'habitat",
                      "Nombre de micro-habitats",
                      "Nb horizons sol",
                      "Epaisseur d'horizons sol",
                      "Abondance relative de faune détritivore",
                      "Nb sp faune dep hab reproduction",
                      "Nb TGB",
                      "% bois mort",
                      "Nb sp bio-indicatrices",
                      "Densité de lichen",
                      "Ancienneté de la forêt",
                      "Nb sp pollinisatrices",
                      "% flore dominante",
                      "Nb strates végétation",
                      "Hauteur strates",
                      "% sol dégradé",
                      "Nb sp indicatrices de pression",
                      "Tps depuis dernière coupe",
                      "Tx recouvrement ligneux",
                      "Tx couvert algues eutrophisation",
                      "Indice frag type hab",
                      "Surface d'habitat dans le PE",
                      "% surf hab _ PE")

    for(i in 1:length(habitat)){
      name <- paste("CC no.", habitat[i])
      if(exists(name, where = ecoval)){
        namehab <- paste("Habitat", habitat[i])
        partial_select <- c(1,2,3,4,5,6,7,8,9,16,17,18,19,20,24,25,26)
        if(ecoval[[namehab]][4,2] == "1"){ # Fermé
          partial_select <- c(partial_select, c(10,11,12,13,14,21))
        }else if(ecoval[[namehab]][4,2] == "2"){ # Ouvert
          partial_select <- c(partial_select, c(15, 22))
        }else if(ecoval[[namehab]][4,2] == "4"){ # Zone humide
          partial_select <- c(partial_select, c(16, 23))
        }
        tabhab <- ecoval[[name]][partial_select,]
        tabhab[[3]] <- shortindicnames[partial_select]
        # Gains CT
        cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Court Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabhab[[1]],
          indicateurs = tabhab[[3]],
          criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
          # valeurs = as.numeric(tabhab[[7]]),
          incertitudes <- gsub("[ABC]", "*", tabhab[[7]]),
          gains_bruts <- as.numeric(tabhab[[8]]) - as.numeric(tabhab[[4]]),
          gains_relatifs <- (as.numeric(tabhab[[8]]) - as.numeric(tabhab[[4]])) * 100 / as.numeric(tabhab[[4]])
        )
        dat1[[5]][is.na(dat1[[5]])] <- 0
        dat1[[5]][is.nan(dat1[[5]])] <- 0
        dat1[[6]][is.na(dat1[[6]])] <- 0
        dat1[[6]][is.nan(dat1[[6]])] <- 0
        dat1[[6]][is.infinite(dat1[[6]])] <- 0
        dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
          geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
        # Gains LT
        cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Long Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
            perimetres = tabhab[[1]],
            indicateurs = tabhab[[3]],
            criteres = factor(tabhab[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            #valeurs = as.numeric(tabhab[[7]]),
            incertitudes <- gsub("[ABC]", "*", tabhab[[10]]),
            gains_bruts <- as.numeric(tabhab[[11]]) - as.numeric(tabhab[[4]]),
            gains_relatifs <- (as.numeric(tabhab[[11]]) - as.numeric(tabhab[[4]])) * 100 / as.numeric(tabhab[[4]])
          )
        dat1[[5]][is.na(dat1[[5]])] <- 0
        dat1[[5]][is.nan(dat1[[5]])] <- 0
        dat1[[6]][is.na(dat1[[6]])] <- 0
        dat1[[6]][is.nan(dat1[[6]])] <- 0
        dat1[[6]][is.infinite(dat1[[6]])] <- 0
        dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
            geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
            coord_flip()+
            labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
            scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
            theme_bw()+
            theme(legend.position="none")+
            geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
            theme(axis.text.x=element_text(colour="black", size = 11))+
            geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
            theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
            facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)

     }
   }
 }

```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#9BBB59'>*Niveau Espèce*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
      # liste les especes du site compensatoire
      name <- paste("Site no.", input$selectsitecompens4)
      species <- list()
      nbspecies <- dim(listspecies)[1] - 1
      if(nbspecies > 0){
        for(i in 1:nbspecies){
          sname <- listspecies$species[i+1]
          if(exists(sname, where = ecoval)){
            if(ecoval[[sname]][6,2] == ecoval[[name]][12,2]){
              species[[listspecies$name[i+1]]] <- listspecies$index[i+1]
            }
          }
        }
      }
     # affichage
     if(length(species) > 0){
        shortindicnames <- c("Surf tot hab favorable",
                             "Nb patchs hab favorable",
                             "Estimation nb indiv",
                             "Surf nourrissage favorable",
                             "Surf reproduction favorable",
                             "Estimation nb couples",
                             "Surf chasse favorable",
                             "Nb gîtes favorables",
                             "Nb mâles chanteurs",
                             "Nb pontes",
                             "% plante(s) hôte(s)",
                             "Nb station / pieds",
                             "Nombre d'sp",
                             "Nombre de familles",
                             "% Surf SANS perturbation",
                             "Surf hab favorable _ PE",
                             "Nb osb sp",
                             "Surf hab favorable connecté _ PE",
                             "Nb zones connectées entre elles")
       for(i in 1:length(species)){
         name <- paste("DC no.", species[i])
         if(exists(name, where = ecoval)){
             namesp  <- paste("Espece", species[i])
             partial_select <- c(1,2,15,16,17,18,19)
            if(ecoval[[namesp]][3,2] != "7"){ # Faune
              partial_select <- c(partial_select, c(3))
            }
            if(ecoval[[namesp]][3,2] == "1"){ # Avifaune
              partial_select <- c(partial_select, c(4,5,6))
            }else if(ecoval[[namesp]][3,2] == "2"){ # Chiroptere
              partial_select <- c(partial_select, c(7,8))
            }else if(ecoval[[namesp]][3,2] == "4"){ # Amphibien
              partial_select <- c(partial_select, c(9,10))
            }else if(ecoval[[namesp]][3,2] == "6"){ # Insecte
              partial_select <- c(partial_select, c(11))
            }else if(ecoval[[namesp]][3,2] == "7"){ # Flore
              partial_select <- c(partial_select, c(12))
            }else if(ecoval[[namesp]][3,2] == "10"){ # Communaute faunistique
              partial_select <- c(partial_select, c(13,14))
            }
            tabsp <- ecoval[[name]][partial_select,]
            tabsp[[3]] <- shortindicnames[partial_select]
            # Gains CT
            cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Court Terme", "**", "\n\n", sep=''))
            dat1 <- data.frame(
            perimetres = tabsp[[1]],
            indicateurs = tabsp[[3]],
            criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            # valeurs = as.numeric(tabsp[[7]]),
            incertitudes <- gsub("[ABC]", "*", tabsp[[7]]),
            gains_bruts <- as.numeric(tabsp[[8]]) - as.numeric(tabsp[[4]]),
            gains_relatifs <- (as.numeric(tabsp[[8]]) - as.numeric(tabsp[[4]])) * 100 / as.numeric(tabsp[[4]])
            )
            dat1[[5]][is.na(dat1[[5]])] <- 0
            dat1[[5]][is.nan(dat1[[5]])] <- 0
            dat1[[6]][is.na(dat1[[6]])] <- 0
            dat1[[6]][is.nan(dat1[[6]])] <- 0
            dat1[[6]][is.infinite(dat1[[6]])] <- 0
            dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
            p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
              geom_bar(stat="identity",  width=0.5, aes(fill=colour)) +
              coord_flip()+
              labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
              scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
              theme_bw()+
              theme(legend.position="none")+
              geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
              theme(axis.text.x=element_text(colour="black", size = 11))+
              geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
              theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
              facet_grid(criteres ~ ., scales = "free", space = "free")
            print(p)
            # Gains LT
            cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Long Terme", "**", "\n\n", sep=''))
            dat1 <- data.frame(
            perimetres = tabsp[[1]],
            indicateurs = tabsp[[3]],
            criteres = factor(tabsp[[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE", "Structure")),
            # valeurs = as.numeric(tabsp[[7]]),
            incertitudes <- gsub("[ABC]", "*", tabsp[[10]]),
            gains_bruts <- as.numeric(tabsp[[11]]) - as.numeric(tabsp[[4]]),
            gains_relatifs <- (as.numeric(tabsp[[11]]) - as.numeric(tabsp[[4]])) * 100 / as.numeric(tabsp[[4]])
            )
            dat1[[5]][is.na(dat1[[5]])] <- 0
            dat1[[5]][is.nan(dat1[[5]])] <- 0
            dat1[[6]][is.na(dat1[[6]])] <- 0
            dat1[[6]][is.nan(dat1[[6]])] <- 0
            dat1[[6]][is.infinite(dat1[[6]])] <- 0
            dat1$colour <- ifelse(dat1$gains_relatifs < 0, "negative","positive")
            p <- ggplot(data=dat1, aes(x=indicateurs, y=gains_relatifs)) +
              geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
              coord_flip()+
              labs(x="Indicateurs", y="Gains relatifs (barre) et bruts (nombre)")+
              scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
              theme_bw()+
              theme(legend.position="none")+
              geom_text(aes(label=gains_bruts, hjust="center", vjust="center", y=gains_relatifs*0.5), size=3)+
              theme(axis.text.x=element_text(colour="black", size = 11))+
              geom_text(aes(label=incertitudes, hjust="center", vjust="bottom", y= gains_bruts))+
              theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
              facet_grid(criteres ~ ., scales = "free", space = "free")
              print(p)
          }
        }
     }
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

--------------------------------------

# <span style='color:#B2A1C7'>**Equivalence `r listsite$name[as.numeric(input$selectsiteimpact4)+1]` -- `r listsite$name[as.numeric(input$selectsitecompens4)+1]`**</span> {#link3}

### <span style='color:#B2A1C7'>*Niveau Général*</span>

#### **Court Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
nameImp <- paste("SIB no.", input$selectsiteimpact4)
nameComp <- paste("SCB no.", input$selectsitecompens4)
shortindicnames <- c("Nb hab forestier",
               "Surf hab forestier",
               "Nb hab ouvert",
               "Surf hab ouvert",
               "Nb hab buiss",
               "Surf hab buiss",
               "Nb hab rocheux",
               "Surf hab rocheux",
               "Nb hab humide",
               "Surf hab humide",
               "Nb hab aqua",
               "Surf hab aqua",
               "Lg lisière _ ha forêt",
               "Diversité avifaune",
               "Diversité chiroptères",
               "Diversité reptiles",
               "Diversité amphibiens",
               "Diversité mammifères",
               "Diversité insectes",
               "Diversité lépidoptères",
               "Diversité odonates",
               "Diversité orthoptères",
               "Diversité coléoptères",
               "Diversité flore totale",
               "% habitat en danger localement",
               "% habitat d'intérêt comm +prio",
               "% sp protégées faune national et regional",
               "% sp protégées flore national et regional",
               "% sp menacées faune national",
               "% sp menacées flore national",
               "% sp menacées faune regional",
               "% sp menacées flore regional",
               "% sp faune DFFH",
               "% sp flore DFFH",
               "% avifaune DO",
               "% oiseaux nicheurs",
               "% sp repro site",
               "Indice de spé avifaune",
               "% chiroptères spécialistes",
               "% hab bon état conservation",
               "Surf milieux NON cultivés",
               "Surf zones NON urbanisées",
               "Nb sp EEE",
               "Nb patchs EEE",
               "% recouvrement EEE",
               "Lg linéaire transpt",
               "Lg linéaire haie",
               "Surf corridor",
               "Nb Sp TVB",
               "% hab forestier _ PE",
               "% hab ouvert _ PE",
               "% hab rocheux _ PE",
               "% hab aqua _ PE",
               "% hab humide _ PE",
               "% hab buiss _ PE",
               "Nb zonage",
               "Nb Sp faune ZNIEFF",
               "Nb Sp flore ZNIEFF",
               "% milieu cultivés_PE",
               "% zones arti_PE",
               "Surf EEE prox")

        # Equivalence CT
        moins <- as.numeric(ecoval[[nameImp]][[7]]) - as.numeric(ecoval[[nameImp]][[4]])
        plus <- as.numeric(ecoval[[nameComp]][[7]]) - as.numeric(ecoval[[nameComp]][[4]])
        equivalCT <- moins + plus
        dat1 <- data.frame(
          perimetres = ecoval[[nameImp]][[1]],
          indicateurs = shortindicnames, #ecoval[[nameImp]][[3]],
          criteres = factor(ecoval[[nameImp]][[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE")),
          equivalence = equivalCT)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
        geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Pertes / Gains NETS")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
      print(p)
```

#### **Long Terme**

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=12,  fig.align='left'}
nameImp <- paste("SIB no.", input$selectsiteimpact4)
nameComp <- paste("SCB no.", input$selectsitecompens4)
shortindicnames <- c("Nb hab forestier",
               "Surf hab forestier",
               "Nb hab ouvert",
               "Surf hab ouvert",
               "Nb hab buiss",
               "Surf hab buiss",
               "Nb hab rocheux",
               "Surf hab rocheux",
               "Nb hab humide",
               "Surf hab humide",
               "Nb hab aqua",
               "Surf hab aqua",
               "Lg lisière _ ha forêt",
               "Diversité avifaune",
               "Diversité chiroptères",
               "Diversité reptiles",
               "Diversité amphibiens",
               "Diversité mammifères",
               "Diversité insectes",
               "Diversité lépidoptères",
               "Diversité odonates",
               "Diversité orthoptères",
               "Diversité coléoptères",
               "Diversité flore totale",
               "% habitat en danger localement",
               "% habitat d'intérêt comm +prio",
               "% sp protégées faune national et regional",
               "% sp protégées flore national et regional",
               "% sp menacées faune national",
               "% sp menacées flore national",
               "% sp menacées faune regional",
               "% sp menacées flore regional",
               "% sp faune DFFH",
               "% sp flore DFFH",
               "% avifaune DO",
               "% oiseaux nicheurs",
               "% sp repro site",
               "Indice de spé avifaune",
               "% chiroptères spécialistes",
               "% hab bon état conservation",
               "Surf milieux NON cultivés",
               "Surf zones NON urbanisées",
               "Nb sp EEE",
               "Nb patchs EEE",
               "% recouvrement EEE",
               "Lg linéaire transpt",
               "Lg linéaire haie",
               "Surf corridor",
               "Nb Sp TVB",
               "% hab forestier _ PE",
               "% hab ouvert _ PE",
               "% hab rocheux _ PE",
               "% hab aqua _ PE",
               "% hab humide _ PE",
               "% hab buiss _ PE",
               "Nb zonage",
               "Nb Sp faune ZNIEFF",
               "Nb Sp flore ZNIEFF",
               "% milieu cultivés_PE",
               "% zones arti_PE",
               "Surf EEE prox")

        # Equivalence LT
        moins <- as.numeric(ecoval[[nameImp]][[10]]) - as.numeric(ecoval[[nameImp]][[4]])
        plus <- as.numeric(ecoval[[nameComp]][[10]]) - as.numeric(ecoval[[nameComp]][[4]])
        equivalLT <- moins + plus
        dat1 <- data.frame(
          perimetres = ecoval[[nameImp]][[1]],
          indicateurs = shortindicnames, #ecoval[[nameImp]][[3]],
          criteres = factor(ecoval[[nameImp]][[2]], levels=c("Diversité habitat","Diversité espèce","Patrimonialité_PS","Fonctionnalité","Pression_PS","Connectivité","Représentativité","Patrimonialité_PE","Pression_PE")),
          equivalence = equivalLT)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
        geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Pertes / Gains NETS")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#B2A1C7'>*Niveau Habitat*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
  # liste les habitats
  nameI <- paste("Site no.", input$selectsiteimpact4)
  nameC <- paste("Site no.", input$selectsitecompens4)
  namehabitat <- list()
  indexhabitat <- list()
  nbhabitat <- dim(listhabitat)[1] - 1
  if(nbhabitat > 0){
    for(i in 1:nbhabitat){
      hname <- listhabitat$habitat[i+1]
      if(exists(hname, where = ecoval)){
        if(ecoval[[hname]][7,2] == ecoval[[nameI]][12,2]){
          namehabitat[[listhabitat$name[i+1]]] <- listhabitat$name[i+1]
          indexhabitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
        }
        if(ecoval[[hname]][7,2] == ecoval[[nameC]][12,2]){
          namehabitat[[listhabitat$name[i+1]]] <- listhabitat$name[i+1]
          indexhabitat[[listhabitat$name[i+1]]] <- listhabitat$index[i+1]
        }
      }
    }
  }
 # affichage
 if(length(namehabitat) > 0){
    shortindicnames <- c("Nb sp faune dep hab",
                             "Nb sp flore",
                             "Surface totale habitat",
                             "Nombre de patches d'habitat",
                             "Nombre de micro-habitats",
                             "Nb horizons sol",
                             "Epaisseur d'horizons sol",
                             "Abondance relative de faune détritivore",
                             "Nb sp faune dep hab reproduction",
                             "Nb TGB",
                             "% bois mort",
                             "Nb sp bio-indicatrices",
                             "Densité de lichen",
                             "Ancienneté de la forêt",
                             "Nb sp pollinisatrices",
                             "% flore dominante",
                             "Nb strates végétation",
                             "Hauteur strates",
                             "% sol dégradé",
                             "Nb sp indicatrices de pression",
                             "Tps depuis dernière coupe",
                             "Tx recouvrement ligneux",
                             "Tx couvert algues eutrophisation",
                             "Indice frag type hab",
                             "Surface d'habitat dans le PE",
                             "% surf hab _ PE")
     for(j in 1:length(namehabitat)){
        partial_select <- c(1,2,3,4,5,6,7,8,9,16,17,18,19,20,24,25,26)
        namehab <- paste("Habitat", indexhabitat[j])
        if(ecoval[[namehab]][4,2] == "1"){ # Fermé
          partial_select <- c(partial_select, c(10,11,12,13,14,21))
        }else if(ecoval[[namehab]][4,2] == "2"){ # Ouvert
          partial_select <- c(partial_select, c(15, 22))
        }else if(ecoval[[namehab]][4,2] == "4"){ # Zone humide
          partial_select <- c(partial_select, c(16, 23))
        }
        indicehabitat <- which(listhabitat$name == namehabitat[[j]], arr.ind = TRUE)
        # Equivalence CT
        moins <- c(rep(0., dim(model_C)[1]))
        plus <- c(rep(0., dim(model_C)[1]))
        for(i in indicehabitat){
            hname <- listhabitat$habitat[i]
            if(exists(hname, where = ecoval)){
              if(ecoval[[hname]][7,2] == ecoval[[nameI]][12,2]){ # Pertes
                nameImp <- paste("CI no.", as.character(listhabitat$index[i]))
                nameIC <- nameImp
                moins <- as.numeric(ecoval[[nameImp]][[8]]) - as.numeric(ecoval[[nameImp]][[4]])
              }
              if(ecoval[[hname]][7,2] == ecoval[[nameC]][12,2]){ # Gains
                nameComp <- paste("CC no.", as.character(listhabitat$index[i]))
                nameIC <- nameComp
                plus <- as.numeric(ecoval[[nameComp]][[8]]) - as.numeric(ecoval[[nameComp]][[4]])
              }
            }
        }
        tabhab <- ecoval[[nameIC]][partial_select,]
        tabhab[[3]] <- shortindicnames[partial_select]
        equival <- moins + plus
        equival <- equival[partial_select]
        plus <- plus[partial_select]
        moins <- moins[partial_select]
        cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Court Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabhab[[1]],
          indicateurs = tabhab[[3]],
          criteres = factor(tabhab[[2]], levels=c("Diversité espèce", "Fonctionnalité", "Structure", "Pression_PS", "Connectivité", "Représentativité")),
          equivalence = equival)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
             geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
             coord_flip()+
             labs(x="Indicateurs", y="Pertes / Gains NETS")+
             scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
             theme_bw()+
             theme(legend.position="none")+
             theme(axis.text.x=element_text(colour="black", size = 11))+
             geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
             theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
             facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
        # Equivalence LT
        moins <- c(rep(0., dim(model_C)[1]))
        plus <- c(rep(0., dim(model_C)[1]))
        for(i in indicehabitat){
            hname <- listhabitat$habitat[i]
            if(exists(hname, where = ecoval)){
              if(ecoval[[hname]][7,2] == ecoval[[nameI]][12,2]){ # Pertes
                nameImp <- paste("CI no.", as.character(listhabitat$index[i]))
                nameIC <- nameImp
                moins <- as.numeric(ecoval[[nameImp]][[11]]) - as.numeric(ecoval[[nameImp]][[4]])
              }
              if(ecoval[[hname]][7,2] == ecoval[[nameC]][12,2]){ # Gains
                nameComp <- paste("CC no.", as.character(listhabitat$index[i]))
                nameIC <- nameComp
                plus <- as.numeric(ecoval[[nameComp]][[11]]) - as.numeric(ecoval[[nameComp]][[4]])
              }
            }
        }
        tabhab <- ecoval[[nameIC]][partial_select,]
        tabhab[[3]] <- shortindicnames[partial_select]
        equival <- moins + plus
        equival <- equival[partial_select]
        plus <- plus[partial_select]
        moins <- moins[partial_select]
        cat(paste("\n\n", "**", toupper(ecoval[[namehab]][1,2]), " - Long Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabhab[[1]],
          indicateurs = tabhab[[3]],
          criteres = factor(tabhab[[2]], levels=c("Diversité espèce", "Fonctionnalité", "Structure", "Pression_PS", "Connectivité", "Représentativité")),
          equivalence = equival)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
             geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
             coord_flip()+
             labs(x="Indicateurs", y="Pertes / Gains NETS")+
             scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
             theme_bw()+
             theme(legend.position="none")+
             theme(axis.text.x=element_text(colour="black", size = 11))+
             geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
             theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
             facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
      }    
  }                      
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

### <span style='color:#B2A1C7'>*Niveau Espèce*</span>

```{r echo=FALSE, warning=FALSE, fig.width=6, fig.height=6,  fig.align='left', results='asis'}
  # liste les especes
  nameI <- paste("Site no.", input$selectsiteimpact4)
  nameC <- paste("Site no.", input$selectsitecompens4)
  namespecies <- list()
  indexspecies <- list()
  nbspecies <- dim(listspecies)[1] - 1
  if(nbspecies > 0){
    for(i in 1:nbspecies){
      spname <- listspecies$species[i+1]
      if(exists(spname, where = ecoval)){
        if(ecoval[[spname]][6,2] == ecoval[[nameI]][12,2]){
          namespecies[[listspecies$name[i+1]]] <- listspecies$name[i+1]
          indexspecies[[listspecies$name[i+1]]] <- listspecies$index[i+1]
        }
        if(ecoval[[spname]][6,2] == ecoval[[nameC]][12,2]){
          namespecies[[listspecies$name[i+1]]] <- listspecies$name[i+1]
          indexspecies[[listspecies$name[i+1]]] <- listspecies$index[i+1]
        }
      }
    }
  }
 # affichage
 if(length(namespecies) > 0){
    shortindicnames <- c("Surf tot hab favorable",
                           "Nb patchs hab favorable",
                           "Estimation nb indiv",
                           "Surf nourrissage favorable",
                           "Surf reproduction favorable",
                           "Estimation nb couples",
                           "Surf chasse favorable",
                           "Nb gîtes favorables",
                           "Nb mâles chanteurs",
                           "Nb pontes",
                           "% plante(s) hôte(s)",
                           "Nb station / pieds",
                           "Nombre d'sp",
                           "Nombre de familles",
                           "% Surf SANS perturbation",
                           "Surf hab favorable _ PE",
                           "Nb osb sp",
                           "Surf hab favorable connecté _ PE",
                           "Nb zones connectées entre elles")
     for(j in 1:length(namespecies)){
        partial_select <- c(1,2,15,16,17,18,19)
        namesp  <- paste("Espece", indexspecies[j])
        if(ecoval[[namesp]][3,2] != "7"){ # Faune
          partial_select <- c(partial_select, c(3))
        }
        if(ecoval[[namesp]][3,2] == "1"){ # Avifaune
          partial_select <- c(partial_select, c(4,5,6))
        }else if(ecoval[[namesp]][3,2] == "2"){ # Chiroptere
          partial_select <- c(partial_select, c(7,8))
        }else if(ecoval[[namesp]][3,2] == "4"){ # Amphibien
          partial_select <- c(partial_select, c(9,10))
        }else if(ecoval[[namesp]][3,2] == "6"){ # Insecte
          partial_select <- c(partial_select, c(11))
        }else if(ecoval[[namesp]][3,2] == "7"){ # Flore
          partial_select <- c(partial_select, c(12))
        }else if(ecoval[[namesp]][3,2] == "10"){ # Communaute faunistique
          partial_select <- c(partial_select, c(13,14))
        }
        indicespecies <- which(listspecies$name == namespecies[[j]], arr.ind = TRUE)
        # Equivalence CT
        moins <- c(rep(0., dim(model_D)[1]))
        plus <- c(rep(0., dim(model_D)[1]))
        for(i in indicespecies){
            spname <- listspecies$species[i]
            if(exists(spname, where = ecoval)){
              if(ecoval[[spname]][6,2] == ecoval[[nameI]][12,2]){ # Pertes
                nameImp <- paste("DI no.", as.character(listspecies$index[i]))
                nameIC <- nameImp
                moins <- as.numeric(ecoval[[nameImp]][[8]]) - as.numeric(ecoval[[nameImp]][[4]])
              }
              if(ecoval[[spname]][6,2] == ecoval[[nameC]][12,2]){ # Gains
                nameComp <- paste("DC no.", as.character(listspecies$index[i]))
                nameIC <- nameComp
                plus <- as.numeric(ecoval[[nameComp]][[8]]) - as.numeric(ecoval[[nameComp]][[4]])
              }
            }
        }
        tabsp <- ecoval[[nameIC]][partial_select,]
        tabsp[[3]] <- shortindicnames[partial_select]
        equival <- moins + plus
        equival <- equival[partial_select]
        plus <- plus[partial_select]
        moins <- moins[partial_select]
        cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Court Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabsp[[1]],
          indicateurs = tabsp[[3]],
          criteres = factor(tabsp[[2]], levels=c("Diversité espèce", "Fonctionnalité", "Pression_PS", "Connectivité", "Représentativité")),
          equivalence = equival)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
             geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
             coord_flip()+
             labs(x="Indicateurs", y="Pertes / Gains NETS")+
             scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
             theme_bw()+
             theme(legend.position="none")+
             theme(axis.text.x=element_text(colour="black", size = 11))+
             geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
             theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
             facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
        # Equivalence LT
        moins <- c(rep(0., dim(model_D)[1]))
        plus <- c(rep(0., dim(model_D)[1]))
        for(i in indicespecies){
            spname <- listspecies$species[i]
            if(exists(spname, where = ecoval)){
              if(ecoval[[spname]][6,2] == ecoval[[nameI]][12,2]){ # Pertes
                nameImp <- paste("DI no.", as.character(listspecies$index[i]))
                nameIC <- nameImp
                moins <- as.numeric(ecoval[[nameImp]][[11]]) - as.numeric(ecoval[[nameImp]][[4]])
              }
              if(ecoval[[spname]][6,2] == ecoval[[nameC]][12,2]){ # Gains
                nameComp <- paste("DC no.", as.character(listspecies$index[i]))
                nameIC <- nameComp
                plus <- as.numeric(ecoval[[nameComp]][[11]]) - as.numeric(ecoval[[nameComp]][[4]])
              }
            }
        }
        tabsp <- ecoval[[nameIC]][partial_select,]
        tabsp[[3]] <- shortindicnames[partial_select]
        equival <- moins + plus
        equival <- equival[partial_select]
        plus <- plus[partial_select]
        moins <- moins[partial_select]
        cat(paste("\n\n", "**", toupper(ecoval[[namesp]][2,2]), " - Long Terme", "**", "\n\n", sep=''))
        dat1 <- data.frame(
          perimetres = tabsp[[1]],
          indicateurs = tabsp[[3]],
          criteres = factor(tabsp[[2]], levels=c("Diversité espèce", "Fonctionnalité", "Pression_PS", "Connectivité", "Représentativité")),
          equivalence = equival)
        dat1[[4]][is.na(dat1[[4]])] <- 0
        dat1$colour <- ifelse(dat1$equivalence < 0, "negative","positive")
        p <- ggplot(data=dat1, aes(x=indicateurs, y= equivalence)) +
        geom_bar(stat="identity",  width=0.5, aes(fill=colour))+
          coord_flip()+
          labs(x="Indicateurs", y="Pertes / Gains NETS")+
          scale_fill_manual(values=c(positive="#7FDD4C",negative="#C67677")) +
          theme_bw()+
          theme(legend.position="none")+
          theme(axis.text.x=element_text(colour="black", size = 11))+
          geom_text(aes(label=equivalence, hjust="center", vjust="center", y= equivalence))+
          theme(panel.grid.major = element_line(size = 0.5, colour = "light grey"))+
          facet_grid(criteres ~ ., scales = "free", space = "free")
        print(p)
      }    
  }                      
```

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="10" cols="110">
  </textarea>
</form>

--------------------------------------

# <span style='color:#B2A1C7'>**Conclusion**</span> {#link4}

<form>
  <label>Commentaires :</label><br>
  <textarea id="txt_comment1" name="txt_comment1" rows="20" cols="110">
  </textarea>
</form>
